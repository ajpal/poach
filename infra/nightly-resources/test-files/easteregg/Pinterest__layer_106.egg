(datatype Fill
  (LinearGradient)
  (RadialGradient)
  (Color f64 f64 f64 f64))

(datatype BlendMode
  (SrcOver)
  (DstIn)
  (Src)
  ;; No specific rewrites for these blend modes
  (Plus)
  (Multiply)
  (Overlay)
  (SoftLight))

(datatype Style
  (Solid)
  (Stroke))

(datatype Filter
  (IdFilter)
  (LumaFilter))

(datatype SkPaint
  (Paint Fill BlendMode Style Filter i64))

(datatype Geometry
  (Full)
  (Path i64)
  (Rect f64 f64 f64 f64)
  (RRect f64 f64 f64 f64 f64 f64 f64 f64)
  (Oval f64 f64 f64 f64)
  (TextBlob f64 f64 f64 f64 f64 f64)
  (ImageRect f64 f64 f64 f64)
  (Intersect Geometry Geometry)
  (Difference Geometry Geometry))

(datatype Transform
  (Matrix f64 f64 f64 f64 f64 f64 f64 f64 f64 f64 f64 f64 f64 f64 f64 f64))

(sort Layer)
(constructor Empty () Layer)
(constructor Clip (Layer Geometry Transform) Layer :unextractable)
(constructor SaveLayer (Layer Layer SkPaint) Layer :cost 100)
(constructor Draw (Layer Geometry SkPaint Geometry Transform) Layer)

;;----------------
;; Rewrites Below
;;----------------
(ruleset opt)
(ruleset simp)
;; REWRITE 1
(rewrite (SaveLayer l (Empty) (Paint (Color 1.0 r g b) (SrcOver) style (IdFilter) i))
         l
         :ruleset opt)

;; REWRITE 2
(rewrite (SaveLayer (Empty) (Draw (Empty) g (Paint f bm st ftr i2) c t) (Paint (Color 1.0 r1 g1 b1) (SrcOver) st2 (IdFilter) i1))
         (Draw (Empty) g (Paint f bm st ftr i2) c t)
         :ruleset opt)

;; REWRITE 3
(rewrite (SaveLayer l1
                    (Draw l2 g (Paint (Color a2 r2 g2 b2) (SrcOver) f2  ftr i2) c t)
                    (Paint (Color 1.0 r1 g1 b1) (SrcOver) f1 (IdFilter) i1))
         (Draw (SaveLayer l1 l2 (Paint (Color 1.0 r1 g1 b1) (SrcOver) f1 (IdFilter) i1))
               g
               (Paint (Color a2 r2 g2 b2) (SrcOver) f2 ftr i2) c t)
         :ruleset opt)

;; REWRITE 4
(rewrite (Draw (Empty) e (Paint (Color 0.0 r g b) (Src) f (IdFilter) i) c t)
         (Empty)
         :ruleset simp)

;; new rewrite
(rewrite (SaveLayer bottom
                    (Draw (Empty) (Rect w x y z) (Paint (Color 1.0 r2 g2 b2) (SrcOver) (Solid) (IdFilter) i2) c2 t)
                    (Paint (Color 1.0 r3 g3 b3) (DstIn) st2 (IdFilter) i3))
         (Clip bottom (Intersect (Rect w x y z) c2) t)
         :ruleset opt)

(rewrite (SaveLayer bottom
                    (Draw (Empty) (RRect a b c d w x y z) (Paint (Color 1.0 r2 g2 b2) (SrcOver) (Solid) (IdFilter) i2) c2 t)
                    (Paint (Color 1.0 r3 g3 b3) (DstIn) st2 (IdFilter) i3))
         (Clip bottom (Intersect (RRect a b c d w x y z) c2) t)
         :ruleset opt)

(rewrite (SaveLayer bottom
                    (Draw (Empty) (Path nm) (Paint (Color 1.0 r2 g2 b2) (SrcOver) (Solid) (IdFilter) i2) c2 t)
                    (Paint (Color 1.0 r3 g3 b3) (DstIn) st2 (IdFilter) i3))
         (Clip bottom (Intersect (Path nm) c2) t)
         :ruleset opt)

;; Clip rewrites
(rewrite (Clip (Draw bottom geo paint clip1 transform) clip2 transform)
         (Draw (Clip bottom clip2 transform) geo paint (Intersect clip1 clip2) transform)
         :ruleset opt)

(rewrite (Clip (Empty) clip transform)
         (Empty)
         :ruleset opt)

;; Luminance masks
(rewrite (SaveLayer (Empty)
                    (Draw (Empty) shape (Paint (Color 1.0 1.0 1.0 1.0) (SrcOver) style (IdFilter) i1) clip transform)
                    (Paint (Color 1.0 r g b) (SrcOver) nostyle (LumaFilter) i2))
         (Draw (Empty) shape (Paint (Color 1.0 0.0 0.0 0.0) (SrcOver) style (IdFilter) i1) clip transform)
         :ruleset opt)

(let test (Draw (Draw (Draw (Draw (Draw (Draw (Draw (Draw (Draw (Draw (SaveLayer (Draw (Draw (Draw (Draw (Empty) (Full) (Paint (Color 0.0 0.0 0.0 0.0) (Src) (Solid) (IdFilter) 0) (Full) (Matrix 1.0 0.0 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 1.0)) (Rect 0.0 0.0 1280.0 80.0) (Paint (Color 1.0 1.0 1.0 1.0) (SrcOver) (Solid) (IdFilter) 1) (Full) (Matrix 1.0 0.0 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 1.0)) (Path 5) (Paint (Color 1.0 1.0 1.0 1.0) (SrcOver) (Solid) (IdFilter) 5) (Intersect (Full) (Rect 0.0 0.0 98.0 18.0)) (Matrix 1.0 0.0 0.0 28.0 0.0 1.0 0.0 30.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 1.0)) (Path 6) (Paint (Color 1.0 0.9019607843137255 0.0 0.13725490196078433) (SrcOver) (Solid) (IdFilter) 6) (Intersect (Full) (Rect 0.0 0.0 98.0 18.0)) (Matrix 1.0 0.0 0.0 28.0 0.0 1.0 0.0 30.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 1.0)) (SaveLayer (Draw (Draw (Draw (Draw (Draw (Draw (Draw (Draw (Draw (Draw (Empty) (Path 10) (Paint (Color 1.0 0.9019607843137255 0.0 0.13725490196078433) (SrcOver) (Solid) (IdFilter) 10) (Intersect (Intersect (Full) (Rect 0.0 0.0 98.0 18.0)) (Rect 21.0 0.0 98.0 18.0)) (Matrix 1.0 0.0 0.0 28.0 0.0 1.0 0.0 30.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 1.0)) (Path 11) (Paint (Color 1.0 0.9019607843137255 0.0 0.13725490196078433) (SrcOver) (Solid) (IdFilter) 11) (Intersect (Intersect (Full) (Rect 0.0 0.0 98.0 18.0)) (Rect 21.0 0.0 98.0 18.0)) (Matrix 1.0 0.0 0.0 28.0 0.0 1.0 0.0 30.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 1.0)) (Path 12) (Paint (Color 1.0 0.9019607843137255 0.0 0.13725490196078433) (SrcOver) (Solid) (IdFilter) 12) (Intersect (Intersect (Full) (Rect 0.0 0.0 98.0 18.0)) (Rect 21.0 0.0 98.0 18.0)) (Matrix 1.0 0.0 0.0 28.0 0.0 1.0 0.0 30.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 1.0)) (Path 13) (Paint (Color 1.0 0.9019607843137255 0.0 0.13725490196078433) (SrcOver) (Solid) (IdFilter) 13) (Intersect (Intersect (Full) (Rect 0.0 0.0 98.0 18.0)) (Rect 21.0 0.0 98.0 18.0)) (Matrix 1.0 0.0 0.0 28.0 0.0 1.0 0.0 30.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 1.0)) (Path 14) (Paint (Color 1.0 0.9019607843137255 0.0 0.13725490196078433) (SrcOver) (Solid) (IdFilter) 14) (Intersect (Intersect (Full) (Rect 0.0 0.0 98.0 18.0)) (Rect 21.0 0.0 98.0 18.0)) (Matrix 1.0 0.0 0.0 28.0 0.0 1.0 0.0 30.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 1.0)) (Path 15) (Paint (Color 1.0 0.9019607843137255 0.0 0.13725490196078433) (SrcOver) (Solid) (IdFilter) 15) (Intersect (Intersect (Full) (Rect 0.0 0.0 98.0 18.0)) (Rect 21.0 0.0 98.0 18.0)) (Matrix 1.0 0.0 0.0 28.0 0.0 1.0 0.0 30.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 1.0)) (Path 16) (Paint (Color 1.0 0.9019607843137255 0.0 0.13725490196078433) (SrcOver) (Solid) (IdFilter) 16) (Intersect (Intersect (Full) (Rect 0.0 0.0 98.0 18.0)) (Rect 21.0 0.0 98.0 18.0)) (Matrix 1.0 0.0 0.0 28.0 0.0 1.0 0.0 30.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 1.0)) (Path 17) (Paint (Color 1.0 0.9019607843137255 0.0 0.13725490196078433) (SrcOver) (Solid) (IdFilter) 17) (Intersect (Intersect (Full) (Rect 0.0 0.0 98.0 18.0)) (Rect 21.0 0.0 98.0 18.0)) (Matrix 1.0 0.0 0.0 28.0 0.0 1.0 0.0 30.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 1.0)) (Path 18) (Paint (Color 1.0 0.9019607843137255 0.0 0.13725490196078433) (SrcOver) (Solid) (IdFilter) 18) (Intersect (Intersect (Full) (Rect 0.0 0.0 98.0 18.0)) (Rect 21.0 0.0 98.0 18.0)) (Matrix 1.0 0.0 0.0 28.0 0.0 1.0 0.0 30.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 1.0)) (Path 19) (Paint (Color 1.0 0.9019607843137255 0.0 0.13725490196078433) (SrcOver) (Solid) (IdFilter) 19) (Intersect (Intersect (Full) (Rect 0.0 0.0 98.0 18.0)) (Rect 21.0 0.0 98.0 18.0)) (Matrix 1.0 0.0 0.0 28.0 0.0 1.0 0.0 30.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 1.0)) (SaveLayer (Empty) (Draw (Empty) (Path 28) (Paint (Color 1.0 1.0 1.0 1.0) (SrcOver) (Solid) (IdFilter) 28) (Intersect (Intersect (Intersect (Full) (Rect 0.0 0.0 98.0 18.0)) (Rect 21.0 0.0 98.0 18.0)) (Rect 21.0 0.0 98.0 18.0)) (Matrix 1.0 0.0 0.0 28.0 0.0 1.0 0.0 30.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 1.0)) (Paint (Color 1.0 0.0 0.0 0.0) (SrcOver) (Solid) (LumaFilter) 26)) (Paint (Color 1.0 0.0 0.0 0.0) (DstIn) (Solid) (IdFilter) 21)) (Paint (Color 1.0 0.0 0.0 0.0) (SrcOver) (Solid) (IdFilter) 7)) (TextBlob 154.0 46.0 -0.15625 -13.0 57.6432 4.0) (Paint (Color 1.0 0.06666666666666667 0.06666666666666667 0.06666666666666667) (SrcOver) (Solid) (IdFilter) 35) (Full) (Matrix 1.0 0.0 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 1.0)) (TextBlob 242.953 46.0 -1.15625 -13.0 40.1484 4.0) (Paint (Color 1.0 0.06666666666666667 0.06666666666666667 0.06666666666666667) (SrcOver) (Solid) (IdFilter) 36) (Full) (Matrix 1.0 0.0 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 1.0)) (TextBlob 729.047 46.0 -1.15625 -13.0 46.7891 2.0) (Paint (Color 1.0 0.06666666666666667 0.06666666666666667 0.06666666666666667) (SrcOver) (Solid) (IdFilter) 37) (Full) (Matrix 1.0 0.0 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 1.0)) (TextBlob 807.016 46.0 -0.15625 -14.0 87.1797 2.0) (Paint (Color 1.0 0.06666666666666667 0.06666666666666667 0.06666666666666667) (SrcOver) (Solid) (IdFilter) 38) (Full) (Matrix 1.0 0.0 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 1.0)) (TextBlob 924.875 46.0 -1.15625 -13.0 51.4167 2.0) (Paint (Color 1.0 0.06666666666666667 0.06666666666666667 0.06666666666666667) (SrcOver) (Solid) (IdFilter) 39) (Full) (Matrix 1.0 0.0 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 1.0)) (TextBlob 1007.59 46.0 -0.15625 -13.0 43.3333 2.0) (Paint (Color 1.0 0.06666666666666667 0.06666666666666667 0.06666666666666667) (SrcOver) (Solid) (IdFilter) 40) (Full) (Matrix 1.0 0.0 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 1.0)) (RRect 1090.0 16.0 1167.0 64.0 24.0 24.0 24.0 24.0) (Paint (Color 1.0 0.9019607843137255 0.0 0.13725490196078433) (SrcOver) (Solid) (IdFilter) 41) (Full) (Matrix 1.0 0.0 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 1.0)) (TextBlob 1105.61 46.0 -0.15625 -14.0 45.7891 5.0) (Paint (Color 1.0 1.0 1.0 1.0) (SrcOver) (Solid) (IdFilter) 42) (Full) (Matrix 1.0 0.0 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 1.0)) (RRect 1175.0 16.0 1264.0 64.0 24.0 24.0 24.0 24.0) (Paint (Color 1.0 0.9137254901960784 0.9137254901960784 0.9137254901960784) (SrcOver) (Solid) (IdFilter) 43) (Full) (Matrix 1.0 0.0 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 1.0)) (TextBlob 1191.05 46.0 -1.15625 -14.0 57.9453 5.0) (Paint (Color 1.0 0.06666666666666667 0.06666666666666667 0.06666666666666667) (SrcOver) (Solid) (IdFilter) 44) (Full) (Matrix 1.0 0.0 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 1.0)))
(run-schedule
 ;; (repeat 1 (run simp))
 (saturate (run opt)))

(extract test)
